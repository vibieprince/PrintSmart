<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Secure Billing - PrintSmart</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

body {
  font-family: 'Inter', sans-serif;
  background: #0f172a;
  background: radial-gradient(circle at top, #1e293b 0%, #020617 100%);
  background-attachment: fixed;
}

.glass-panel {
  background: rgba(30, 41, 59, 0.7);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.upload-box {
  background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23475569FF' stroke-width='2' stroke-dasharray='6%2c 14'/%3e%3c/svg%3e");
}
.upload-box.active {
  background-color: rgba(99, 102, 241, 0.1);
}

.fade-in-up { animation: fadeInUp .6s ease-out forwards; opacity: 0; transform: translateY(20px); }
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
</style>
</head>

<body class="text-slate-200 antialiased">

<div class="min-h-screen flex flex-col items-center justify-center p-4">

  <div class="w-full max-w-md mb-4 fade-in-up" style="animation-delay: .1s;">
    <button onclick="window.history.back()" 
      class="text-sm text-slate-400 hover:text-white flex items-center gap-2">
      <i class="fas fa-arrow-left"></i> Back to Order
    </button>
  </div>

  <div class="w-full max-w-md glass-panel rounded-3xl p-6 sm:p-8 space-y-6 fade-in-up" style="animation-delay: .2s;">

    <div class="text-center">
      <h1 class="text-2xl font-bold">Payment & Confirm</h1>
      <p class="text-xs text-slate-400">Secure Checkout</p>
    </div>

    <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700 space-y-3">
      <div class="flex justify-between">
        <div>
          <p class="text-xs text-slate-400">Merchant</p>
          <p class="font-semibold flex items-center gap-1">
            <span id="shopName">Loading...</span>
            <i class="fas fa-check-circle text-blue-400 text-xs"></i>
          </p>
        </div>
        <div class="text-right">
          <p class="text-xs text-slate-400">Amount</p>
          <p class="text-2xl font-bold text-emerald-400" id="amountDisplay">₹0</p>
        </div>
      </div>

      <div class="h-px bg-slate-700"></div>

      <div class="flex items-center gap-3">
        <div class="bg-indigo-500/20 p-2 rounded-lg text-indigo-400">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="flex-1 overflow-hidden">
          <p class="text-xs font-medium truncate" id="fileName"></p>
          <p class="text-[10px] text-slate-400" id="fileConfig"></p>
        </div>
      </div>
    </div>

    <!-- PAYMENT BUTTONS -->
    <div class="space-y-3">

      <button id="btnPhonePe" class="w-full bg-purple-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
        <i class="fa-brands fa-android"></i> Pay with PhonePe
      </button>

      <button id="btnGPay" class="w-full bg-blue-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
        <i class="fa-brands fa-google"></i> Pay with Google Pay
      </button>

      <button id="btnPaytm" class="w-full bg-sky-500 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
        <i class="fa-brands fa-paypal"></i> Pay with Paytm
      </button>

      <button id="btnOthers" class="w-full bg-slate-300 text-black py-3 rounded-xl font-bold flex items-center justify-center gap-2">
        <i class="fa-solid fa-mobile"></i> Pay with Other UPI Apps
      </button>

    </div>

    <!-- Screenshot Upload Form -->
    <form id="confirmForm" class="space-y-4 pt-2">

      <label class="block text-xs font-semibold">Upload Payment Screenshot</label>
      <div class="upload-box rounded-2xl p-4 flex flex-col items-center justify-center cursor-pointer"
        onclick="document.getElementById('screenshotInput').click()">

        <input type="file" id="screenshotInput" accept="image/*" class="hidden" required />

        <div id="uploadPlaceholder">
          <i class="fas fa-cloud-upload-alt text-2xl text-slate-500 mb-1"></i>
          <p class="text-[10px] text-slate-400">Click to upload</p>
        </div>

        <div id="uploadPreview" class="hidden flex-col items-center">
          <i class="fas fa-check-circle text-emerald-400 text-2xl mb-1"></i>
          <p class="text-[10px] text-emerald-400 font-bold" id="previewFileName">Selected</p>
        </div>
      </div>

      <button type="submit" id="confirmBtn"
        class="primary-btn w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2">
        <span>Verify & Place Order</span>
      </button>

    </form>

  </div>
</div>

<script type="module">

/* FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, push, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFoM9lP2TFF0PqgGwtAFN8YoGSJznhujc",
  authDomain: "printsmart-ebcdd.firebaseapp.com",
  databaseURL: "https://printsmart-ebcdd-default-rtdb.firebaseio.com",
  projectId: "printsmart-ebcdd"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dfdwbx1lk/auto/upload";
const CLOUDINARY_PRESET = "printsmart_unsigned";

/* LOAD ORDER DATA */
let orderData = JSON.parse(localStorage.getItem("printOrder"));
let studentUID = localStorage.getItem("studentUID") || ("guest_" + Date.now());

if (!orderData) {
  alert("Session expired.");
  window.location.href = "order-create.html";
}

localStorage.setItem("studentUID", studentUID);

/* PRICE */
const RATE_BW = 2;
const RATE_COLOR = 10;
const A3_MULTIPLIER = 2;

let rate = orderData.printType === "color" ? RATE_COLOR : RATE_BW;
if (orderData.pageSize === "A3") rate *= A3_MULTIPLIER;

const total = rate * orderData.detectedPages * orderData.copies;
document.getElementById("amountDisplay").textContent = "₹" + total;
document.getElementById("shopName").textContent = orderData.shopName;
document.getElementById("fileName").textContent = orderData.fileName;
document.getElementById("fileConfig").textContent =
  `${orderData.detectedPages} Pages • ${orderData.copies} Copies • ${orderData.printType.toUpperCase()}`;

/* LOAD SHOP UPI */
let shopUPI = "";
const shopRef = ref(db, `shops/${orderData.shopId}`);
get(shopRef).then(snap => {
  if (snap.exists()) {
    shopUPI = snap.val().upi;
  }
});

/* PERSONAL-UPI COMPATIBLE INTENTS */
function payPhonePe() {
  window.location.href = `phonepe://pay?pa=${shopUPI}&pn=${encodeURIComponent(orderData.shopName)}&cu=INR`;
}
function payGPay() {
  window.location.href = `tez://upi/pay?pa=${shopUPI}&pn=${encodeURIComponent(orderData.shopName)}&cu=INR`;
}
function payPaytm() {
  window.location.href = `paytmmp://pay?pa=${shopUPI}&pn=${encodeURIComponent(orderData.shopName)}&cu=INR`;
}
function payOthers() {
  window.location.href = `upi://pay?pa=${shopUPI}&pn=${encodeURIComponent(orderData.shopName)}&cu=INR`;
}

/* BIND BUTTONS */
document.getElementById("btnPhonePe").onclick = payPhonePe;
document.getElementById("btnGPay").onclick = payGPay;
document.getElementById("btnPaytm").onclick = payPaytm;
document.getElementById("btnOthers").onclick = payOthers;

/* FILE PREVIEW */
const fileInput = document.getElementById("screenshotInput");
fileInput.addEventListener("change", () => {
  if (fileInput.files[0]) {
    document.querySelector(".upload-box").classList.add("active");
    document.getElementById("uploadPlaceholder").classList.add("hidden");
    document.getElementById("uploadPreview").classList.remove("hidden");
    let name = fileInput.files[0].name;
    document.getElementById("previewFileName").textContent =
      name.length > 14 ? name.slice(0, 14) + "..." : name;
  }
});

/* FINAL ORDER SUBMIT */
const confirmForm = document.getElementById("confirmForm");
const confirmBtn = document.getElementById("confirmBtn");

confirmForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  confirmBtn.disabled = true;
  confirmBtn.innerHTML = "Uploading...";

  try {
    const fd = new FormData();
    fd.append("file", fileInput.files[0]);
    fd.append("upload_preset", CLOUDINARY_PRESET);

    const res = await fetch(CLOUDINARY_URL, { method: "POST", body: fd });
    const data = await res.json();

    const finalOrder = {
      ...orderData,
      screenshotUrl: data.secure_url,
      totalCost: total,
      paymentMethod: "UPI-DEMO",
      status: "pending_approval",
      timestamp: Date.now(),
      userRef: studentUID,
    };

    await set(push(ref(db, "orders")), finalOrder);

    confirmBtn.innerHTML = "Done!";
    setTimeout(() => {
      alert("Order submitted successfully!");
      window.location.href = "dashboard.html";
    }, 600);

  } catch (error) {
    alert("Error: " + error.message);
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = "Verify & Place Order";
  }
});

</script>
</body>
</html>
